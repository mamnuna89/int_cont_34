{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>BPMN –†–µ–¥–∞–∫—Ç–æ—Ä</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #canvas {
            width: 100%;
            height: 500px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .form-block {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        select, input[type="text"] {
            width: 300px;
            padding: 5px;
        }
        button {
            padding: 10px 20px;
            font-weight: bold;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>

    <script src="{% static 'bpmn/bpmn-modeler.development.js' %}"></script>
</head>
<body>

<h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ö–µ–º –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞</h1>

<div class="form-block">
    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã:</label>
    <input type="text" id="name" name="name" required>
</div>

<div class="form-block">
    <label for="department">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
    <select id="department" name="department_id" required>
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>
        {% for dept in departments %}
            <option value="{{ dept.id }}">{{ dept.name }}</option>
        {% endfor %}
    </select>
</div>

<div class="form-block">
    <label for="division">–û—Ç–¥–µ–ª:</label>
    <select id="division" name="division_id" required>
        <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç --</option>
    </select>
</div>

<div id="canvas"></div>

<button onclick="saveDiagram()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ö–µ–º—É</button>

<script>
    const bpmnModeler = new BpmnJS({
        container: '#canvas',
        keyboard: { bindTo: window }
    });

    const defaultDiagram = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  id="Definitions_1"
                  targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:process id="Process_1" isExecutable="false">
    <bpmn:startEvent id="StartEvent_1"/>
    <bpmn:task id="Task_1" name="–ê–Ω–∞–ª–∏–∑ –∑–∞—è–≤–∫–∏"/>
    <bpmn:exclusiveGateway id="Gateway_1"/>
    <bpmn:task id="Task_2" name="–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è"/>
    <bpmn:endEvent id="EndEvent_1"/>

    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1"/>
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="Gateway_1"/>
    <bpmn:sequenceFlow id="Flow_3" sourceRef="Gateway_1" targetRef="Task_2"/>
    <bpmn:sequenceFlow id="Flow_4" sourceRef="Task_2" targetRef="EndEvent_1"/>
  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="100" y="100" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
        <dc:Bounds x="200" y="90" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1_di" bpmnElement="Gateway_1" isMarkerVisible="true">
        <dc:Bounds x="340" y="105" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_2_di" bpmnElement="Task_2">
        <dc:Bounds x="430" y="90" width="120" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="600" y="100" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="136" y="118"/>
        <di:waypoint x="200" y="130"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="300" y="130"/>
        <di:waypoint x="340" y="130"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_3_di" bpmnElement="Flow_3">
        <di:waypoint x="390" y="130"/>
        <di:waypoint x="430" y="130"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_4_di" bpmnElement="Flow_4">
        <di:waypoint x="550" y="130"/>
        <di:waypoint x="600" y="118"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

    bpmnModeler.importXML(defaultDiagram);

    // —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—Ç–¥–µ–ª–æ–≤ –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É
    const divisionsByDepartment = {
        {% for dept in departments %}
            {{ dept.id }}: [
                {% for div in dept.divisions.all %}
                    {id: {{ div.id }}, name: "{{ div.name }}"},
                {% endfor %}
            ],
        {% endfor %}
    };

    // –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—ã
    document.getElementById('department').addEventListener('change', function () {
        const deptId = this.value;
        const divisionSelect = document.getElementById('division');
        divisionSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª --</option>';
        if (divisionsByDepartment[deptId]) {
            divisionsByDepartment[deptId].forEach(function (div) {
                const option = document.createElement('option');
                option.value = div.id;
                option.textContent = div.name;
                divisionSelect.appendChild(option);
            });
        }
    });

    async function saveDiagram() {
        const name = document.getElementById('name').value;
        const departmentId = document.getElementById('department').value;
        const divisionId = document.getElementById('division').value;

        if (!name || !departmentId || !divisionId) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            return;
        }

        const { xml } = await bpmnModeler.saveXML({ format: true });

        fetch("{% url 'save_process_diagram' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({
                name: name,
                department_id: departmentId,
                division_id: divisionId,
                bpmn_xml: xml
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert("‚úÖ –°—Ö–µ–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
                window.location.href = "{% url 'diagram_list' %}";
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã.");
            }
        });
    }
</script>

</body>
</html>
